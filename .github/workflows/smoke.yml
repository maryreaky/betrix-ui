name: smoke
on:
  push:
    paths:
      - "scripts/**"
      - ".github/workflows/smoke.yml"
jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Install deps
        run: |
          if [ -f package.json ]; then
            npm ci
          fi
      - name: Start worker service
        run: |
          # Replace the line below with your real start command if different
          npm start &> worker.start.log & disown $!
      - name: Wait for port 3000
        run: |
          set -e
          timeout=60
          waited=0
          while [ $waited -lt $timeout ]; do
            if curl -fsS http://localhost:3000/health > /dev/null 2>&1; then
              echo "service started after ${waited}s"
              exit 0
            fi
            sleep 1
            waited=$((waited+1))
          done
          echo "service did not start within ${timeout}s" >&2
          exit 2
      - name: Run smoke check
        run: |
          ./scripts/smoke.sh
  smoke-test-failure:
    needs: smoke-test
    if: always() && failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show worker start log
        run: |
          if [ -f worker.start.log ]; then
            echo "==== worker.start.log ===="
            sed -n '1,400p' worker.start.log || true
            echo "==== end worker.start.log ===="
          fi
