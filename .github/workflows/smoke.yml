name: smoke-test (Docker publish + inside-container probe)
on:
  workflow_dispatch: {}
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      PORT: 10000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull node:22 image
        run: docker pull node:22

      - name: Run container with port published and HOST=0.0.0.0
        shell: bash
        run: |
          set -euo pipefail
          WORKDIR=$GITHUB_WORKSPACE
          PORT=${PORT:-10000}
          COMMIT_SHA=${COMMIT_SHA:-$(git rev-parse --short HEAD)}
          CONTAINER_NAME="betrix-smoke-pub-${GITHUB_RUN_ID:-local}"

          echo "Starting container $CONTAINER_NAME with -p 10000:10000 and HOST=0.0.0.0"
          docker run --rm -d --name "$CONTAINER_NAME" -p ${PORT}:${PORT} -v "$WORKDIR":"$WORKDIR":rw -w "$WORKDIR" -e PORT=${PORT} -e HOST=0.0.0.0 node:22 \
            bash -lc "npm ci --silent && if npm run | grep -q build; then npm run build; fi && echo starting server && PORT=${PORT} COMMIT_SHA=${COMMIT_SHA} HOST=0.0.0.0 node server.js > server.log 2>&1" || true

          sleep 2

          echo "---- docker ps (container) ----"
          docker ps --filter name="$CONTAINER_NAME" || true

          echo "---- docker logs (tail 200) ----"
          docker logs "$CONTAINER_NAME" --tail 200 || true

          echo "---- inside-container: check listening sockets and curl localhost:${PORT} ----"
          docker exec "$CONTAINER_NAME" sh -c "ss -lntp 2>/dev/null || netstat -tulpen 2>/dev/null || true"
          docker exec "$CONTAINER_NAME" sh -c "echo 'inside curl:'; curl --silent --fail -v http://localhost:${PORT} || echo inside-curl-failed" || true

          echo "---- runner: probe http://localhost:${PORT} from runner ----"
          if curl --silent --fail "http://localhost:${PORT}" >/dev/null 2>&1; then
            echo "runner curl succeeded"
          else
            echo "runner curl failed; dumping more diagnostics"
            echo "---- container logs (tail 1000) ----"
            docker logs "$CONTAINER_NAME" --tail 1000 || true
            echo "---- docker top ----"
            docker top "$CONTAINER_NAME" || true
            echo "---- try copying server.log from container ----"
            docker exec "$CONTAINER_NAME" sh -c 'if [ -f server.log ]; then echo "server.log exists; tail:"; tail -n 200 server.log; else echo "no server.log"; fi' || true
            docker kill "$CONTAINER_NAME" 2>/dev/null || true
            exit 1
          fi

          echo "runner curl success; dumping container short logs and stopping container"
          docker logs "$CONTAINER_NAME" --tail 200 || true
          docker kill "$CONTAINER_NAME" 2>/dev/null || true