name: CI (force Node 22 + smoke)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    env:
      PORT: 10000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (22.x)
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Confirm Node version
        run: |
          echo "node -v:"
          node -v
          echo "npm -v:"
          npm -v

      - name: Install deps
        run: npm ci

      - name: Build (if present)
        run: |
          if npm run | grep -q build; then npm run build; else echo "no build script"; fi

      - name: Start server and diagnostics
        shell: bash
        run: |
          set -euo pipefail
          PORT=${PORT:-10000}
          COMMIT_SHA=${COMMIT_SHA:-$(git rev-parse --short HEAD)}
          echo "Starting server on port $PORT"
          PORT=$PORT COMMIT_SHA=$COMMIT_SHA node server.js > server.log 2>&1 & PID=$! || true
          echo "server pid=$PID"
          sleep 2
          echo "---- server.log (head 200) ----"
          head -n 200 server.log || true
          echo "---- ps aux | grep node ----"
          ps aux | egrep 'node|server.js' || true
          echo "---- Listening sockets ----"
          ss -lntp 2>/dev/null || netstat -tulpen 2>/dev/null || true
          echo "Waiting up to 90s for http://localhost:$PORT ..."
          for ((i=1;i<=90;i++)); do
            if curl --silent --fail "http://localhost:$PORT" >/dev/null 2>&1; then
              echo "ready after $i seconds"
              exit 0
            fi
            sleep 1
          done
          echo "ERROR: server did not bind; dumping server.log tail"
          tail -n 500 server.log || true
          ps auxww | egrep 'node|server.js' || true
          ss -lntp 2>/dev/null || netstat -tulpen 2>/dev/null || true
          kill $PID 2>/dev/null || true
          exit 1